<!DOCTYPE html>
<html class="theme-next pisces use-motion">
<head>
  <title>我的网站</title>
  <meta charset="UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <meta name="theme-color" content="#222">
  <meta http-equiv="Cache-Control" content="no-transform"/>
  <meta http-equiv="Cache-Control" content="no-siteapp"/>
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>
  <link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"/>
  <link href="/css/pisces.css?v=5.1.4" rel="stylesheet" type="text/css"/>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">
  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">
  <meta name="description">
  <meta property="og:type" content="website">
  <meta property="og:title" content="我的网站">
  <meta property="og:url">
  <meta property="og:site_name" content="我的网站">
  <meta property="og:locale" content="zh_CN">
  <meta property="article:author" content="Docs4dev">
  <meta name="twitter:card">

  <script type="text/javascript" id="hexo.configurations">
    var scheme = "Pisces";
    var NexT = window.NexT || {};
    var CONFIG = {
      root: '/',
      scheme: scheme,
      version: '5.1.4',
      sidebar: {
        "position": "left",
        "display": "post",
        "offset": 12,
        "b2t": false,
        "scrollpercent": false,
        "onmobile": false
      },
      fancybox: true,
      tabs: true,
      motion: {
        "enable": true,
        "async": false,
        "transition": {
          "post_block": "fadeIn",
          "post_header": "slideDownIn",
          "post_body": "slideDownIn",
          "coll_header": "slideLeftIn",
          "sidebar": "slideUpIn"
        }
      },
    };
  </script>
  <link rel="canonical" href=""/>
  <meta name="generator" content="Docs4dev template engine">
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="en">
<div class="container sidebar-position-left page-home">
  <div class="headband"></div>
  
  <header id="header" class="header">
    <div class="header-inner">
      <div class="site-brand-wrapper">
        <div class="site-meta ">
          <div class="custom-logo-site-title">
            <a href="/" class="brand" rel="start">
              <span class="logo-line-before"><i></i></span>
              <span class="site-title">我的网站</span>
              <span class="logo-line-after"><i></i></span>
            </a>
          </div>
          <p class="site-subtitle"></p>
        </div>

        <div class="site-nav-toggle">
          <button>
            <span class="btn-bar"></span>
            <span class="btn-bar"></span>
            <span class="btn-bar"></span>
          </button>
        </div>
      </div>

      <nav class="site-nav">
        <ul id="menu" class="menu">
          <li class="menu-item menu-item-home">
            <a href="/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br/>
              <span>首页</span>
            </a>
          </li>
          <li class="menu-item menu-item-archives">
            <a href="/archives" rel="section">
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br/>
              <span>归档</span>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </header>


  <main id="main" class="main">
    <div class="main-inner">
      <div class="content-wrap">
        <div id="content" class="content">
          <section id="posts" class="posts-expand">
            <article class="post post-type-normal">
              <div class="post-block">
                <header class="post-header">
                  <h1 class="post-title" itemprop="name headline">
                    <a class="post-title-link"
                       href="/posts/-nginx-bing-fa-liang-tai-gao-nginxkang-bu-zhu-zhe-ci-wo-cuo-guai-nginxle.html"
                       itemprop="url"
                    >【Nginx】并发量太高，Nginx扛不住？这次我错怪Nginx了！！</a>
                  </h1>
                  <div class="post-meta">
                    <span class="post-time">
                      <span class="post-meta-item-icon">
                        <i class="fa fa-calendar-o"></i>
                      </span>
                      <span class="post-meta-item-text">Posted on</span>
                      <time title="Post created"
                            itemprop="dateCreated datePublished"
                            datetime="2020-07-24T10:57:25"
                      >2020-07-24T10:57:25</time>
                    </span>
                    
                  </div>
                </header>
                <div class="post-body" itemprop="articleBody">
                  <div><h1 id="nginx并发量太高nginx扛不住这次我错怪nginx了"><a href="#nginx并发量太高nginx扛不住这次我错怪nginx了" id="nginx并发量太高nginx扛不住这次我错怪nginx了"></a>【Nginx】并发量太高，Nginx扛不住？这次我错怪Nginx了！！</h1>
<h2 id="写在前面"><a href="#写在前面" id="写在前面"></a>写在前面</h2>
<blockquote>
<p>最近，在服务器上搭建了一套压测环境，不为别的，就为压测下Nginx的性能，到底有没有传说中的那么牛逼！具体环境为：11台虚拟机，全部安装CentOS 6.8 64位操作系统，1台安装部署Nginx，其他10台作为客户端同时以压满CPU的线程向Nginx发送请求，对Nginx进行压测。没想到，出现问题了！！</p>
</blockquote>
<h2 id="nginx报错"><a href="#nginx报错" id="nginx报错"></a>Nginx报错</h2>
<p>Nginx服务器访问量非常高，在Nginx的错误日志中不停的输出如下错误信息。</p>
<pre><code class="hljs language-shell">2020-07-23 02:53:49 [alert] 13576#0: accept() failed (24: Too many open files)
2020-07-23 02:53:49 [alert] 13576#0: accept() failed (24: Too many open files)
2020-07-23 02:53:49 [alert] 13576#0: accept() failed (24: Too many open files)
2020-07-23 02:53:49 [alert] 13576#0: accept() failed (24: Too many open files)
2020-07-23 02:53:49 [alert] 13576#0: accept() failed (24: Too many open files)
2020-07-23 02:53:49 [alert] 13576#0: accept() failed (24: Too many open files)
2020-07-23 02:53:49 [alert] 13576#0: accept() failed (24: Too many open files)
2020-07-23 02:53:49 [alert] 13576#0: accept() failed (24: Too many open files)
2020-07-23 02:53:49 [alert] 13576#0: accept() failed (24: Too many open files)
2020-07-23 02:53:49 [alert] 13576#0: accept() failed (24: Too many open files)
复制代码
</code></pre>
<p>根据错误日志的输出信息，我们可以看出：是打开的文件句柄数太多了，导致Nginx报错了！那我们该如何解决这个问题呢？</p>
<h2 id="问题分析"><a href="#问题分析" id="问题分析"></a>问题分析</h2>
<p>既然我们能够从Nginx的错误日志中基本能够确定导致问题的原因，那这到底是不是Nginx本身的问题呢？答案为：是，也不全是！</p>
<p>为啥呢？原因很简单：Nginx无法打开那么多的文件句柄，一方面是因为我没有配置Nginx能够打开的最大文件数；另一方面是因为CentOS 6.8操作系统本身对打开的最大文件句柄数有限制，我同样没有配置操作系统的最大文件句柄数。所以说，不全是Nginx的锅！在某种意义上说，我错怪Nginx了！</p>
<p>在CentOS 6.8服务器中，我们可以在命令行输入如下命令来查看服务器默认配置的最大文件句柄数。</p>
<pre><code class="hljs language-shell">[root@binghe150 ~]# ulimit -n
1024
复制代码
</code></pre>
<p>可以看到，在CentOS 6.8服务器中，默认的最大文件句柄数为1024。</p>
<p>此时，当Nginx的连接数超过1024时，Nginx的错误日志中就会输出如下错误信息。</p>
<pre><code class="hljs language-shell">[alert] 13576#0: accept() failed (24: Too many open files)
复制代码
</code></pre>
<h2 id="解决问题"><a href="#解决问题" id="解决问题"></a>解决问题</h2>
<p>那我们该如何解决这个问题呢？其实，也很简单，继续往下看！</p>
<p>使用如下命令可以把打开文件句柄数设置的足够大。</p>
<pre><code class="hljs language-shell">ulimit -n 655350
复制代码
</code></pre>
<p>同时修改nginx.conf ， 添加如下配置项。</p>
<pre><code class="hljs language-shell">worker_rlimit_nofile 655350; 
复制代码
</code></pre>
<p><strong>注意：上述配置需要与error_log同级别。</strong></p>
<p>这样就可以解决Nginx连接过多的问题，Nginx就可以支持高并发（这里需要配置Nginx）。</p>
<p>另外，  <code>ulimit -n</code>还会影响到MySQL的并发连接数。把它提高，也可以提高MySQL的并发。</p>
<p><strong>注意： 用  <code>ulimit -n 655350</code>  修改只对当前的shell有效，退出后失效。</strong></p>
<h2 id="永久解决问题"><a href="#永久解决问题" id="永久解决问题"></a>永久解决问题</h2>
<p>若要令修改ulimits的数值永久生效，则必须修改配置文件，可以给ulimit修改命令放入/etc/profile里面，这个方法实在是不方便。</p>
<p>还有一个方法是修改/etc/security/limits.conf配置文件，如下所示。</p>
<pre><code class="hljs language-shell">vim /etc/security/limits.conf
复制代码
</code></pre>
<p>在文件最后添加如下配置项。</p>
<pre><code class="hljs language-shell">* soft nofile 655360
* hard nofile 655360
复制代码
</code></pre>
<p>保存并退出vim编辑器。</p>
<p>其中：星号代表全局， soft为软件，hard为硬件，nofile为这里指可打开的文件句柄数。</p>
<p>最后，需要注意的是：要使 limits.conf 文件配置生效，必须要确保 pam_limits.so 文件被加入到启动文件中。查看 /etc/pam.d/login 文件中是否存在如下配置。</p>
<pre><code class="hljs language-shell">session required /lib64/security/pam_limits.so
复制代码
</code></pre>
<p>不存在，则需要添加上述配置项。</p>
</div>
                  <!--noindex-->
                  <div class="post-button text-center">
                    <a class="btn" href="/posts/-nginx-bing-fa-liang-tai-gao-nginxkang-bu-zhu-zhe-ci-wo-cuo-guai-nginxle.html" rel="contents">
                      Read more &raquo;
                    </a>
                  </div>
                  <!--/noindex-->
                </div>
                <footer class="post-footer">
                  <div class="post-eof"></div>
                </footer>
              </div>
            </article>
          </section>
          <section id="posts" class="posts-expand">
            <article class="post post-type-normal">
              <div class="post-block">
                <header class="post-header">
                  <h1 class="post-title" itemprop="name headline">
                    <a class="post-title-link"
                       href="/posts/helloword.html"
                       itemprop="url"
                    >hello word</a>
                  </h1>
                  <div class="post-meta">
                    <span class="post-time">
                      <span class="post-meta-item-icon">
                        <i class="fa fa-calendar-o"></i>
                      </span>
                      <span class="post-meta-item-text">Posted on</span>
                      <time title="Post created"
                            itemprop="dateCreated datePublished"
                            datetime="2020-07-24T10:31:40"
                      >2020-07-24T10:31:40</time>
                    </span>
                    
                  </div>
                </header>
                <div class="post-body" itemprop="articleBody">
                  <div><p>hello world</p>
</div>
                  <!--noindex-->
                  <div class="post-button text-center">
                    <a class="btn" href="/posts/helloword.html" rel="contents">
                      Read more &raquo;
                    </a>
                  </div>
                  <!--/noindex-->
                </div>
                <footer class="post-footer">
                  <div class="post-eof"></div>
                </footer>
              </div>
            </article>
          </section>
          
  

        </div>
      </div>
      
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>
  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">
      
  <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
    <div class="site-overview">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <img class="site-author-image"
             itemprop="image"
             src="/images/avatar.gif"
             alt="avatar"/>
        <p class="site-author-name" itemprop="name">Docs4dev</p>
        <p class="site-description motion-element" itemprop="description"></p>
      </div>
      <nav class="site-state motion-element">
        <div class="site-state-item site-state-posts">
          <a href="/archives">
            <span class="site-state-item-count">2</span>
            <span class="site-state-item-name">文章</span>
          </a>
        </div>
        <div class="site-state-item site-state-categories">
          <span class="site-state-item-count">1</span>
          <span class="site-state-item-name">分类</span>
        </div>
        <div class="site-state-item site-state-tags">
          <span class="site-state-item-count">0</span>
          <span class="site-state-item-name">标签</span>
        </div>
      </nav>
    </div>
  </section>

    </div>
  </aside>

    </div>
  </main>

  
  <footer id="footer" class="footer">
    <div class="footer-inner">
      <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
        <span class="with-love">
          <i class="fa fa-user"></i>
        </span>
        <span class="author" itemprop="copyrightHolder">Docs4dev</span>
      </div>
      <div class="powered-by">Powered by <a class="theme-link" target="_blank"
                                            href="https://www.docs4dev.com">Docs4dev</a></div>
      <span class="post-meta-divider">|</span>
      <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank"
                                               href="https://github.com/docs4dev/theme-next">NexT</a> v5.1.4
      </div>
    </div>
  </footer>

  
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
  </div>

</div>

  <script type="text/javascript">
    if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
      window.Promise = null;
    }
  </script>
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>
  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>
  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>
  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>
  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>

</body>
</html>
